---
title: "PanMyeloid Assignment--Data Exploration"
author: "ZHANG, Yiling"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: true
    df_print: paged
    gallery: false
    highlight: tango
pkgdown:
  as_is: true    
---


```{r include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  fig.width = 6,
  autodep = TRUE,
  cache.lazy = FALSE
)
```

# 1. Environment Setting

```{r}
# Single-cell required
library(Seurat)
library(SeuratDisk)

# For data analysis
library(dplyr)
library(tidyr)
library(stringr)

# For plotting
library(ggplot2)
library(cowplot)
library(ggridges)
library(ggsci)
library(ggraph)
library(clustree)
```

```{r}
packageVersion("Seurat")
```

# 2. Collected Dataset(LUNG) Preprocessing
## 2.1 Convert to Seurat Object
```{r cache=TRUE}
Convert("../processedData/scanpy_qc_filtered_LUNG.h5ad", dest = "h5seurat", overwrite = TRUE)
LUNG <- LoadH5Seurat("../processedData/scanpy_qc_filtered_LUNG.h5seurat")
LUNG
```

## 2.2 Add MetaData
```{r}
meta <- read.table("../rawData/LUNG/meta/GSE127465_human_cell_metadata_54773x25.tsv.gz",header = T,sep = "\t")
head(meta)
```

```{r}
metaNow <- LUNG@meta.data
metaNow$Barcode <- rownames(metaNow)
metaNow[,"Barcode"] <- unlist(lapply(metaNow$Barcode,function(x){return(strsplit(x, "-")[[1]][1])}))

colnames(meta)[1] <- "patient"
meta <- meta[which(meta$Library %in% c("p1b1","p1t1","p2b1","p2t1","p3b1","p3t1","p4b1","p4t1","p5t1","p6b1","p6t1","p7b1","p7t1")),]
meta[,"patient"] <- unlist(lapply(meta$patient,function(x){paste0("LUNG_",x)}))
meta <- select(meta,-one_of("used_in_NSCLC_all_cells","x_NSCLC_all_cells","y_NSCLC_all_cells","used_in_NSCLC_and_blood_immune","x_NSCLC_and_blood_immune","y_NSCLC_and_blood_immune","used_in_NSCLC_immune","x_NSCLC_immune","y_NSCLC_immune","used_in_NSCLC_non_immune","x_NSCLC_non_immune","y_NSCLC_non_immune","used_in_blood","x_blood","y_blood"))

metaNow <- merge(metaNow, meta, by = c("Library","Barcode"),sort=F, all.x=TRUE)
metaNow <- unite(metaNow,"index",c("Barcode","batch"), sep="-", remove = F)
rownames(metaNow) <- metaNow$index

LUNG <- AddMetaData(object = LUNG, metadata = metaNow)
LUNG@meta.data <- select(LUNG@meta.data, -one_of("index","patient.y"))
```

Convert to h5ad for AnnData
```{r}
SaveH5Seurat(LUNG, filename = "../processedData/metadata_added_filtered_LUNG.h5Seurat")
Convert("../processedData/metadata_added_filtered_LUNG.h5Seurat", dest = "h5ad")
```

## 2.3 Marker-based Annotation

> **RESULTS**: We performed unsupervised graph-based clustering on myeloid cells and then identified four common major linages (mast cells, pDCs, cDCs, monocytes, or macrophages) based on canonical cell markers. In addition, cDCs and monocytes or macrophages could be further divided into multiple sub-populations (Figure S1C, STAR methods). Using esophageal carcinoma (ESCA) as an example, mast cells, pDCs, cDCs, and monocytes/macrophages were characterized by specific high expression of KIT, LILRA4, HLA/FCER1A, and CD68/CD163, respectively (Figures 1C and 1D). Three distinct subsets in cDCs were identified (Figures 1E and S1C), including two classical cDC subsets (CLEC9A+ cDC1s and CD1C+ cDC2s) and a mature cDC subset (LAMP3+ cDC) recently characterized.

```{r}
celltype_marker_main <- c(
  "KIT", # Mast
  "LILRA4", # pDCs
  "HLA","FCER1A", # cDCs
  "CD163","CD68"# Mono/Macro
)

celltype_marker_fine <- c(
  "CLEC9A", # cDC1 CLEC9A
  "CD1C", # cDC2 CD1C
  "LAMP3",# cDC3 LAMP3
  "CD14", # Mono_CD14
  "CD16", # Mono_CD16
  "VCAN", # Macro_VCAN
  "ISG15", # Macro_ISG15
  "C1QC", # Macro_C1QC
  "MK167" # Myeloid_MK167
)
```

```{r}
LUNG <- SCTransform(LUNG, vars.to.regress = c("percent_mito","percent_hsp"), variable.features.n = 2000, verbose = F, seed.use = 27)
LUNG <- RunPCA(LUNG, npcs = 30, verbose = FALSE)
LUNG <- RunUMAP(LUNG, dims = 1:30)
LUNG <- RunTSNE(object = LUNG, dims = 1:30,check_duplicates = FALSE)
LUNG <- FindNeighbors(object = LUNG, dims = 1:30)
LUNG <- FindClusters(LUNG, resolution = 0.1)
```

```{r fig.width=10}
# Plot the tSNE
p1 <- DimPlot(LUNG, reduction = "tsne", label = TRUE, label.size = 6)
# Plot the UMAP
p2 <- DimPlot(LUNG, reduction = "umap", label = TRUE, label.size = 6)
plot_grid(p1, p2,rel_widths = c(2,2))
```

```{r}
FeaturePlot(object = LUNG, features = celltype_marker_main, cols = c("grey", "blue"), reduction = "umap")
```

```{r}
FeaturePlot(object = LUNG, features = celltype_marker_fine, cols = c("grey", "blue"), reduction = "tsne")
```




# Supplemental Information

<details><summary>**▶ Session Info**</summary>
```{r echo=FALSE}
sessionInfo()
```
</details>


<details><summary>**▶ Server Info**</summary>
* Linux Version
```{bash echo=FALSE}
cat /etc/os-release
```

* CPU info
```{bash echo=FALSE}
lscpu | head -25
```
</details>